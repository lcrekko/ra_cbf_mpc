"""
# -------------- RLS Identification Simulation ---------------

# set a default learning rate
MU_0 = 0.5

# initialize the RLS instance
my_rls = RLS_constant(NUM_PARA, MU_0, acc_kernel, acc_f, acc_g, H_w)

# update the parameter estimate and parameter set estiamte
f_prior, f_add = my_rls.update_para(x_plus, X_INITIAL, u_0, PARA_0, 1)
H_f, h_f = my_rls.update_paraset(x_plus, X_INITIAL, u_0, H_para, h_para, 1)
f_posterior = my_rls.projection(H_f, h_f, f_prior)

print("Control input is:", u_0)

print("The posterior estimate", f_posterior)
"""


# ------------- One-step MPC Simulation --------------

# initialize the MPC controller
ampc_controller = MPCController(N, DT,
                                X_DIM, U_DIM,
                                X_REF, U_REF,
                                -U_LIM, U_LIM,
                                Q, R, P,
                                acc_dynamics, NUM_PARA)

# solve the mpc to get the first input
u_0 = ampc_controller.solve_closed(X_INITIAL, PARA_STAR)

# simulate the system with the first input to get the next state
x_plus = acc_dynamics(X_INITIAL, u_0, DT, PARA_STAR) + DT * w_sim[:, 0] # type: ignore

u_1 = ampc_controller.solve_closed(x_plus, PARA_STAR)

u_1 = np.atleast_1d(u_1)

print("Control input 1 is:", np.shape(u_1))
print("Control input 1 is:", type(u_1))
print(u_1.T @ R @ u_1)  # should be a scalar value

    
# -------------- Plot the regret ----------------
fig_width = 8
gold_ratio = 0.5 * (np.sqrt(5) - 1)
fig_size = (fig_width, fig_width * gold_ratio)
tab_color = (0.8901960784313725, 0.4666666666666667, 0.7607843137254902)
info_text = {"x_label": r'$T$',
             "y_label": r'$\mathrm{Reg}_T$',
             "legend": 'Mean'}
info_font = {"ft_type": "Computer Modern Roman",
             "ft_size_label": fig_width * 4, "ft_size_legend": fig_width * 4, "ft_size_tick": fig_width * 3}


out_fig = plt.figure(figsize=fig_size)
ax = out_fig.add_subplot(1, 1, 1)
myplotter = RegretPlotter(ax, time_plot, regret_table, 
                          info_text, info_font, tab_color)
myplotter.plot_unified()
plt.tight_layout()
plt.savefig("regret_acc.pdf", format="pdf",
            dpi=800, bbox_inches='tight', pad_inches=0.3)
plt.show()